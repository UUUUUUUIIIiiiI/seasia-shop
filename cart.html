<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>购物车 - Seasia Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
  <div class="container my-4">
    <h2>购物车</h2>
    <div id="cartItems"></div>

    <hr />
    <h4>买家信息</h4>
    <form id="orderForm">
      <div class="mb-3">
        <label for="buyerName" class="form-label">姓名</label>
        <input type="text" class="form-control" id="buyerName" required />
      </div>
      <div class="mb-3">
        <label for="buyerPhone" class="form-label">电话</label>
        <input type="tel" class="form-control" id="buyerPhone" required />
      </div>
      <button type="submit" class="btn btn-primary">提交订单</button>
    </form>

    <div id="message" class="mt-3"></div>
  </div>

  <script>
    // 加载购物车（本地存储仅存id和qty）
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");

    // 加载商品列表（商品名、价格）
    async function loadProducts() {
      try {
        const res = await axios.get("http://localhost:5001/api/products");
        return res.data;
      } catch {
        return [];
      }
    }

    // 显示购物车详情
    async function renderCart() {
      const products = await loadProducts();
      if (cart.length === 0) {
        document.getElementById("cartItems").innerHTML = "<p>购物车为空</p>";
        return;
      }
      let html = `<table class="table">
        <thead><tr><th>商品</th><th>单价</th><th>数量</th><th>小计</th></tr></thead><tbody>`;
      let total = 0;
      for (const item of cart) {
        const p = products.find(p => p.id === item.id);
        if (!p) continue;
        const subtotal = p.price * item.qty;
        total += subtotal;
        html += `<tr>
          <td>${p.name}</td>
          <td>￥${p.price.toFixed(2)}</td>
          <td>${item.qty}</td>
          <td>￥${subtotal.toFixed(2)}</td>
        </tr>`;
      }
      html += `</tbody></table>`;
      html += `<h5>总价：￥${total.toFixed(2)}</h5>`;
      document.getElementById("cartItems").innerHTML = html;
      return total;
    }

    // 订单提交
    document.getElementById("orderForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("buyerName").value.trim();
      const phone = document.getElementById("buyerPhone").value.trim();

      if (!name || !phone) {
        alert("请填写姓名和电话");
        return;
      }
      if (cart.length === 0) {
        alert("购物车为空");
        return;
      }

      const products = await loadProducts();

      // 组装订单数据，包含商品名称和数量
      const orderItems = cart.map(ci => {
        const p = products.find(p => p.id === ci.id);
        return p ? { id: p.id, name: p.name, quantity: ci.qty, price: p.price } : null;
      }).filter(Boolean);

      const total = orderItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

      try {
        const res = await axios.post("http://localhost:5001/api/orders", {
          buyer: { name, phone },
          cart: orderItems,
          total
        });
        if (res.data.success) {
          document.getElementById("message").innerHTML = `<div class="alert alert-success">${res.data.message}</div>`;
          localStorage.removeItem("cart");
          renderCart();
        } else {
          document.getElementById("message").innerHTML = `<div class="alert alert-danger">订单提交失败：${res.data.message}</div>`;
        }
      } catch (err) {
        document.getElementById("message").innerHTML = `<div class="alert alert-danger">提交出错，请稍后重试</div>`;
        console.error(err);
      }
    });

    renderCart();
  </script>
</body>
</html>
